{% load static %}

<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Thống kê ra vào hội nghị</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="container my-5">
      <h2 class="mb-4 text-center">THỐNG KÊ RA/VÀO HỘI NGHỊ</h2>

      <div class="mb-5">
        <canvas id="checkTypeChart" height="100"></canvas>
      </div>

      <div class="mb-5">
        <canvas id="dailyChart" height="100"></canvas>
      </div>

      <div class="mb-5">
        <canvas id="activityChart" height="100"></canvas>
      </div>
    </div>

    <script>
      async function fetchAndRender() {
        const response = await fetch("{% url 'api_tracking_dashboard_stats' %}")
        const data = await response.json()
        const stats = data.overall_stats
      
        const labels = []
        const checkIn = [],
          checkOut = []
        const dailyLabels = [],
          dailyCounts = []
        const activityTypes = [],
          activityCounts = []
      
        for (const [code, conf] of Object.entries(stats)) {
          const name = conf.conference_name || code
          const breakdown = conf.stats
      
          labels.push(name)
          checkIn.push(breakdown.check_type_breakdown?.CHECK_IN || 0)
          checkOut.push(breakdown.check_type_breakdown?.CHECK_OUT || 0)
      
          breakdown.daily_tracking_breakdown?.forEach((item) => {
            dailyLabels.push(item.date)
            dailyCounts.push(item.count)
          })
      
          for (const [activity, count] of Object.entries(breakdown.activity_type_breakdown || {})) {
            const idx = activityTypes.indexOf(activity)
            if (idx >= 0) {
              activityCounts[idx] += count
            } else {
              activityTypes.push(activity)
              activityCounts.push(count)
            }
          }
        }
      
        new Chart(document.getElementById('checkTypeChart'), {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Check-in',
                data: checkIn,
                backgroundColor: 'rgba(75, 192, 192, 0.6)'
              },
              {
                label: 'Check-out',
                data: checkOut,
                backgroundColor: 'rgba(255, 99, 132, 0.6)'
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: 'Lượt check-in/check-out theo hội nghị' }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        })
      
        new Chart(document.getElementById('dailyChart'), {
          type: 'line',
          data: {
            labels: dailyLabels,
            datasets: [
              {
                label: 'Tổng lượt ra/vào',
                data: dailyCounts,
                fill: true,
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                borderColor: 'rgba(153, 102, 255, 1)',
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: 'Lượt ra/vào theo ngày' }
            },
            scales: {
              y: { beginAtZero: true }
            }
          }
        })
      
        new Chart(document.getElementById('activityChart'), {
          type: 'pie',
          data: {
            labels: activityTypes,
            datasets: [
              {
                data: activityCounts,
                backgroundColor: activityTypes.map((_, i) => `hsl(${i * 40}, 70%, 60%)`)
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: 'Phân loại hoạt động' }
            }
          }
        })
      }
      
      fetchAndRender()
    </script>
  </body>
</html>
