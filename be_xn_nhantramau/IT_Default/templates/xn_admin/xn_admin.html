{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dynamic Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6;
      }
      .active-link {
        background-color: #374151; /* gray-700 */
        color: #ffffff;
      }
    </style>
  </head>
  <body class="flex min-h-screen">
    <!-- Sidebar Navigation -->
    <aside class="w-64 bg-gray-800 text-gray-100 flex-shrink-0 p-6 rounded-r-2xl shadow-lg">
      <div class="flex items-center space-x-2 mb-8">
        <svg class="h-8 w-8 text-indigo-400" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2L2 7v10l10 5 10-5V7L12 2zM12 4.25l7.25 3.63L12 11.5l-7.25-3.62L12 4.25zM4 9.17l8 4v8l-8-4v-8zM20 13.17l-8 4v-8l8-4v8z" />
        </svg>
        <h1 class="text-xl font-bold">Admin Panel</h1>
      </div>
      <nav class="space-y-4">
        <a href="#" class="flex items-center space-x-3 px-4 py-2 rounded-xl text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200 active-link" data-tab="dashboard">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6" />
          </svg>
          <span>Dashboard</span>
        </a>
        <a href="#" class="flex items-center space-x-3 px-4 py-2 rounded-xl text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200" data-tab="users">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          <span>Users</span>
        </a>
        <a href="#" class="flex items-center space-x-3 px-4 py-2 rounded-xl text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200" data-tab="products">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
          </svg>
          <span>Products</span>
        </a>
        <a href="#" class="flex items-center space-x-3 px-4 py-2 rounded-xl text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200" data-tab="settings">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-.203.79-.059 1.25.123l8.85 4.148M15 19.124a3 3 0 11-6 0 3 3 0 016 0zm-8.85 4.148l8.85-4.148m.123 1.25c.203.426.059.79-.123 1.25" />
          </svg>
          <span>Settings</span>
        </a>
        <a href="/xn/logout" class="flex items-center space-x-3 px-4 py-2 rounded-xl text-gray-300 hover:bg-gray-700 hover:text-white transition duration-200">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          <span>Logout</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-grow p-8">
      <header class="flex items-center justify-between mb-8">
        <h2 class="text-3xl font-bold text-gray-900" id="main-title">Dashboard</h2>
        <div class="flex items-center space-x-4">
          <div id="user-id-display" class="bg-gray-200 text-gray-700 text-sm px-3 py-1.5 rounded-full font-mono hidden md:block"></div>
          <button id="create-new-button" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-medium hover:bg-indigo-700 transition duration-150">Create New</button>
          <div class="relative">
            <img class="h-10 w-10 rounded-full object-cover border-2 border-indigo-400" src="https://placehold.co/40x40/c084fc/ffffff?text=U" alt="User Avatar" />
          </div>
        </div>
      </header>

      <!-- Dynamic Content will be loaded here -->
      <div id="content-area" class="min-h-[500px]">
        <!-- Content will be rendered by JavaScript -->
        <div class="flex items-center justify-center min-h-[500px] text-gray-500">
          <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Loading content...
        </div>
      </div>

      <!-- Delete Confirmation Modal -->
      <div id="delete-modal" class="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-50 hidden flex items-center justify-center">
        <div class="relative bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 mx-auto">
          <div class="text-center">
            <svg class="mx-auto h-12 w-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856a2 2 0 001.995-1.884L22 7.084A2 2 0 0020.084 5H3.916a2 2 0 00-1.995 1.884z" />
            </svg>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Delete User</h3>
            <div class="mt-2">
              <p class="text-sm text-gray-500">Are you sure you want to delete this user? This action cannot be undone.</p>
            </div>
          </div>
          <div class="mt-4 flex justify-end space-x-3">
            <button id="cancel-delete" class="px-4 py-2 rounded-xl text-sm font-medium border border-gray-300 text-gray-700 hover:bg-gray-50">Cancel</button>
            <button id="confirm-delete" class="px-4 py-2 rounded-xl text-sm font-medium bg-red-600 text-white hover:bg-red-700">Delete</button>
          </div>
        </div>
      </div>
    </main>
    <script src="{% static 'js/XetNghiem/check_token.js' %}"></script>
    <script>
      // Run check automatically on page load
      document.addEventListener("DOMContentLoaded", () => {
          checkToken(`{{KEY_AUTHOR}}`);
      });
      // Set up the UI elements and their content templates
      const navLinks = document.querySelectorAll('aside nav a[data-tab]');
      const contentArea = document.getElementById('content-area');
      const mainTitle = document.getElementById('main-title');
      const createNewButton = document.getElementById('create-new-button');
      const userIdDisplay = document.getElementById('user-id-display');
      const deleteModal = document.getElementById('delete-modal');
      const confirmDeleteButton = document.getElementById('confirm-delete');
      const cancelDeleteButton = document.getElementById('cancel-delete');
      let pendingDeleteDocId = null;

      // Mock user data to simulate a backend. This data is managed in-memory.
      let mockUsers = [
        { id: "user_1", name: "Alice Johnson", email: "alice@example.com" },
        { id: "user_2", name: "Bob Smith", email: "bob@example.com" },
        { id: "user_3", name: "Charlie Brown", email: "charlie@example.com" },
      ];

      // A simple mock API that manages the in-memory user data.
      const api = {
        fetchUsers: async () => {
          // Simulate an API call delay
          return new Promise(resolve => setTimeout(() => resolve(mockUsers), 500));
        },
        addUser: async (name, email) => {
          // Simulate an API call to add a user
          return new Promise(resolve => {
            const newUser = {
              id: `user_${Math.random().toString(36).substr(2, 9)}`,
              name,
              email
            };
            mockUsers.push(newUser);
            resolve(newUser);
          });
        },
        deleteUser: async (id) => {
          // Simulate an API call to delete a user
          return new Promise((resolve, reject) => {
            const initialLength = mockUsers.length;
            mockUsers = mockUsers.filter(user => user.id !== id);
            if (mockUsers.length < initialLength) {
              resolve({ success: true });
            } else {
              reject(new Error("User not found"));
            }
          });
        }
      };

      // A simple mock API that manages the in-memory user data.
      const apiXN = {
        fetchDanhSachXetNghiem: async () => {
            try {
            const apiUrl = '/api/pub/xn/nhan-mau/all?TIEPNHAN_ID=18643&FROM_DATE=2025-08-24&TO_DATE=2025-08-29&page=1&limit=100&ordering=-NGAYTAO';
            
            // Perform the GET request. Note: a GET request does not have a body.
            const response = await fetch(apiUrl, {
                method: 'GET',
            });

            // Check if the response was successful (status code 200-299).
            if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status}`);
            }

            // Parse the JSON response and return the data.
            const data = await response.json();
            return data;
            } catch (error) {
            console.error("Error fetching lab test data:", error);
            // Return an empty array or re-throw the error, depending on desired behavior.
            throw error;
            }
        },
        };

      // Template for dashboard content
      const dashboardTemplate = (totalUsers) => `
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex items-center space-x-4">
            <div class="flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 text-indigo-600">
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4m3-1h4M12 11V4h-2a2 2 0 00-2 2v5h4z"/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500">Total Users</p>
              <p class="text-2xl font-semibold text-gray-900">${totalUsers}</p>
            </div>
          </div>
          <!-- Other static dashboard cards can go here -->
          <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex items-center space-x-4">
            <div class="flex items-center justify-center h-12 w-12 rounded-full bg-green-100 text-green-600">
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2S9 11.105 9 10s1.343-2 3-2zM9 10a3 3 0 00-3-3m0 0H4v2h2m0 0v2H4m2-2h2m0 0a3 3 0 013-3m0 0v4m0-4h4m-4 0a3 3 0 01-3 3"/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500">New Orders</p>
              <p class="text-2xl font-semibold text-gray-900">45</p>
            </div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex items-center space-x-4">
            <div class="flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 text-yellow-600">
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l1-1h4l1 1v13a2 2 0 002 2h-12a2 2 0 01-2-2z"/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500">Product Views</p>
              <p class="text-2xl font-semibold text-gray-900">98,765</p>
            </div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 flex items-center space-x-4">
            <div class="flex items-center justify-center h-12 w-12 rounded-full bg-red-100 text-red-600">
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-2a2 2 0 012-2z"/>
              </svg>
            </div>
            <div>
              <p class="text-sm text-gray-500">Pending Tasks</p>
              <p class="text-2xl font-semibold text-gray-900">12</p>
            </div>
          </div>
        </section>
        <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Activity</h3>
          <ul class="divide-y divide-gray-200">
            <li class="py-4 flex items-center space-x-4">
              <div class="flex-shrink-0">
                <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-900 truncate">New user signed up: Jane Doe</p>
                <p class="text-sm text-gray-500">5 minutes ago</p>
              </div>
            </li>
            <li class="py-4 flex items-center space-x-4">
              <div class="flex-shrink-0">
                <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2S9 11.105 9 10s1.343-2 3-2zM9 10a3 3 0 00-3-3m0 0H4v2h2m0 0v2H4m2-2h2m0 0a3 3 0 013-3m0 0v4m0-4h4m-4 0a3 3 0 01-3 3"/>
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-900 truncate">New order from John Smith</p>
                <p class="text-sm text-gray-500">1 hour ago</p>
              </div>
            </li>
          </ul>
        </div>
      `;

      // Function to render the users list from the mock API
      async function renderUsersContent() {
        try {
          const users = await api.fetchUsers();
          contentArea.innerHTML = `
            <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">User Management</h3>
              <form id="add-user-form" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="user-name" class="block w-full px-3 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Name" required>
                <input type="email" id="user-email" class="block w-full px-3 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Email" required>
                <button type="submit" class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Add User</button>
              </form>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50 rounded-t-lg">
                    <tr>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                      <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    ${users.map(user => `
                      <tr>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${user.name}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm text-gray-500">${user.email}</div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                          <button data-id="${user.id}" class="text-red-600 hover:text-red-900 delete-button">Delete</button>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
          // Re-attach event listeners to the new form and buttons
          attachUsersEventListeners();
        } catch (error) {
          console.error("Failed to fetch user data:", error);
          contentArea.innerHTML = `<div class="text-center text-red-500 mt-8">
            <p>Failed to load user data. Please try again.</p>
          </div>`;
        }
      }

      const productsTemplate = `
        <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Product Inventory</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <div class="flex flex-col items-center bg-gray-50 rounded-lg p-4">
              <img src="https://placehold.co/150x150/d1d5db/4b5563?text=Product+1" class="rounded-lg mb-2">
              <p class="text-sm font-medium text-gray-900">Product A</p>
              <p class="text-xs text-gray-500">$29.99</p>
            </div>
            <div class="flex flex-col items-center bg-gray-50 rounded-lg p-4">
              <img src="https://placehold.co/150x150/d1d5db/4b5563?text=Product+2" class="rounded-lg mb-2">
              <p class="text-sm font-medium text-gray-900">Product B</p>
              <p class="text-xs text-gray-500">$49.99</p>
            </div>
            <div class="flex flex-col items-center bg-gray-50 rounded-lg p-4">
              <img src="https://placehold.co/150x150/d1d5db/4b5563?text=Product+3" class="rounded-lg mb-2">
              <p class="text-sm font-medium text-gray-900">Product C</p>
              <p class="text-xs text-gray-500">$19.99</p>
            </div>
          </div>
        </div>
      `;

      const settingsTemplate = `
        <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Site Settings</h3>
          <form class="space-y-6">
            <div>
              <label for="site-name" class="block text-sm font-medium text-gray-700">Site Name</label>
              <div class="mt-1">
                <input type="text" id="site-name" class="block w-full px-3 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              </div>
            </div>
            <div>
              <label for="contact-email" class="block text-sm font-medium text-gray-700">Contact Email</label>
              <div class="mt-1">
                <input type="email" id="contact-email" class="block w-full px-3 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
              </div>
            </div>
            <div>
              <button type="submit" class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Save Settings</button>
            </div>
          </form>
        </div>
      `;

      // Function to render content based on the active tab
      function renderContent(tabName) {
        if (tabName === 'dashboard') {
          contentArea.innerHTML = dashboardTemplate(mockUsers.length);
        } else if (tabName === 'users') {
          contentArea.innerHTML = `
            <div class="flex items-center justify-center min-h-[500px] text-gray-500">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Loading user data...
            </div>
          `;
          renderUsersContent();
        } else if (tabName === 'products') {
          contentArea.innerHTML = productsTemplate;
        } else if (tabName === 'settings') {
          contentArea.innerHTML = settingsTemplate;
        } else if (tabName === 'logout') {
          // Typically, you would handle a proper logout here.
          // For this example, we'll just log a message.
          console.log("Logged out.");
        }
        mainTitle.textContent = tabName.charAt(0).toUpperCase() + tabName.slice(1);
      }

      // Attach event listeners for the Users tab specifically
      function attachUsersEventListeners() {
        const addUserForm = document.getElementById('add-user-form');
        if (addUserForm) {
          addUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;
            if (name && email) {
              await api.addUser(name, email);
              renderUsersContent(); // Re-render the user table
            }
          });
        }
        contentArea.addEventListener('click', async (e) => {
          if (e.target.matches('.delete-button')) {
            pendingDeleteDocId = e.target.getAttribute('data-id');
            deleteModal.classList.remove('hidden');
          }
        });
      }

      // Main function to initialize the app
      function main() {
        renderContent('dashboard');
        
        // Attach all global event listeners
        navLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            navLinks.forEach(nav => nav.classList.remove('active-link'));
            link.classList.add('active-link');
            const tabName = link.getAttribute('data-tab');
            renderContent(tabName);
          });
        });

        // Event listener for the delete confirmation button
        confirmDeleteButton.addEventListener('click', async () => {
          if (pendingDeleteDocId) {
            try {
              await api.deleteUser(pendingDeleteDocId);
              console.log("User deleted successfully!");
              renderUsersContent(); // Re-render the users table after deletion
            } catch (error) {
              console.error("Error removing document: ", error);
            } finally {
              pendingDeleteDocId = null;
              deleteModal.classList.add('hidden');
            }
          }
        });

        // Event listener to cancel the delete
        cancelDeleteButton.addEventListener('click', () => {
          pendingDeleteDocId = null;
          deleteModal.classList.add('hidden');
        });
      }

      // Start the application
      window.onload = main;
    </script>
  </body>
</html>
