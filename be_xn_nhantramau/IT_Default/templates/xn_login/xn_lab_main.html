{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lab Test Results</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }

    .table-container {
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
  <!-- Notification container -->
  <div id="notify-container" class="fixed top-5 right-5 space-y-3 z-50"></div>

  <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-8xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold text-gray-800">Ghi Nh·∫≠n L·∫•y M·∫´u V√† Nh·∫≠n M·∫´u X√©t Nghi·ªám</h1>
      <button id="refreshBtn"
        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">
        <i class="fas fa-sync-alt mr-2"></i> Refresh
      </button>
    </div>

    <!-- Direct Links Section -->
    <div class="flex space-x-4 mb-6">
      <a href="#"
        class="bg-gray-800 hover:bg-gray-900 text-white font-semibold py-2 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">
        Trang Ch·ªß
      </a>
      <a href="/xn/logout"
        class="bg-gray-800 hover:bg-gray-900 text-white font-semibold py-2 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">
        ƒêƒÉng xu·∫•t
      </a>
    </div>

    <!-- User Information Display -->
    <div id="userInfor" class="mb-6 bg-blue-50 p-6 rounded-lg border border-blue-200 hidden">
      <h2 class="text-xl font-bold text-blue-700 mb-4">Th√¥ng tin ng∆∞·ªùi d√πng</h2>
      <!-- User data will be rendered here by JavaScript -->
    </div>

    <!-- Parameter Input Form - now dynamic -->
    <div class="mb-6 bg-gray-50 p-6 rounded-lg border border-gray-200">
      <h2 class="text-xl font-bold text-gray-700 mb-4">Th√¥ng tin t√¨m ki·∫øm</h2>
      <div id="paramsForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Inputs will be dynamically added here -->
      </div>
      <div class="mt-6 flex justify-end">
        <button id="fetchDataBtn"
          class="bg-gray-800 hover:bg-gray-900 text-white font-semibold py-2 px-6 rounded-full shadow-md transition-all duration-300 transform hover:scale-105">
          <i class="fas fa-search mr-2"></i> T√¨m ki·∫øm
        </button>
      </div>
    </div>

    <!-- Loading spinner and message -->
    <div id="loading" class="text-center text-gray-500 my-8 hidden">
      <div
        class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-t-4 border-indigo-600 border-t-transparent">
      </div>
      <p class="mt-2 text-lg">Loading data...</p>
    </div>

    <!-- Table to display lab test data -->
    <div id="tableContainer" class="table-container rounded-lg border border-gray-200 shadow-inner">
      <table id="dataTable" class="min-w-full bg-white divide-y divide-gray-200">
        <thead class="bg-gray-50 sticky top-0 z-10">
          <tr id="tableHeader">
            <!-- Headers will be inserted here by JavaScript -->
          </tr>
        </thead>
        <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
          <!-- Data rows will be inserted here by JavaScript -->
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls -->
    <div id="pagination" class="flex justify-between items-center mt-6">
      <button id="prevBtn"
        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-l-full disabled:opacity-50 disabled:cursor-not-allowed"
        disabled>
        Previous
      </button>
      <span id="pageInfo" class="text-gray-700 font-semibold">Page 1 of 1</span>
      <button id="nextBtn"
        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-r-full disabled:opacity-50 disabled:cursor-not-allowed"
        disabled>
        Next
      </button>
    </div>

  </div>

  <!-- Modal and overlay container -->
  <div id="modalContainer" class="fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div id="modalOverlay" class="absolute inset-0 modal-overlay"></div>
    <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-6xl z-10 relative">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-bold text-gray-800">Th√¥ng tin chi ti·∫øt</h3>
        <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 transition-colors">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div id="modalContent" class="max-h-[70vh] overflow-y-auto">
        <!-- Dynamic content will be rendered here -->
      </div>
    </div>
  </div>

  <script src="{% static 'js/XetNghiem/check_token.js' %}"></script>
  <script src="{% static 'js/XetNghiem/popup_notify.js' %}"></script>
  <script>
    // Run check automatically on page load
    document.addEventListener("DOMContentLoaded", () => {
      checkToken(`{{KEY_AUTHOR}}`);
    });
    const apiXN = {
      /**
       * Fetches a list of lab tests from the specified API endpoint.
       * @param {Object} params An object containing the query parameters.
       * @returns {Promise<Array<Object>>} A promise that resolves with an array of lab test data.
       * @throws {Error} Throws an error if the network request fails or the response is not valid JSON.
       */
      fetchDanhSachXetNghiem: async (params) => {
        try {
          const baseUrl = '/api/pub/xn/nhan-mau/all';
          const queryString = new URLSearchParams(params).toString();
          const apiUrl = `${baseUrl}?${queryString}`;

          const response = await fetch(apiUrl, {
            method: 'GET',
          });

          if (!response.ok) {
            throw new Error(`API call failed with status: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error fetching lab test data:", error);
          throw error;
        }
      },
      fetchCheckLayMau: async (params) => {
        try {
          const baseUrl = '/api/pub/xn/nhan-mau/check-laymau';
          const queryString = new URLSearchParams(params).toString();
          const apiUrl = `${baseUrl}?${queryString}`;

          const response = await fetch(apiUrl, {
            method: 'GET',
          });

          if (!response.ok) {
            throw new Error(`API call failed with status: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error fetching lab test data:", error);
          throw error;
        }
      },
      fetchCheckNhanMau: async (params) => {
        try {
          const baseUrl = '/api/pub/xn/nhan-mau/check-nhanmau';
          const queryString = new URLSearchParams(params).toString();
          const apiUrl = `${baseUrl}?${queryString}`;

          const response = await fetch(apiUrl, {
            method: 'GET',
          });

          if (!response.ok) {
            throw new Error(`API call failed with status: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error fetching lab test data:", error);
          throw error;
        }
      },
      postGhiNhanLayMau: async (params) => {
        try {
          const apiUrl = '/api/pub/xn/ghinhan-trangthai/';

          // üîπ Add extra keys here
          const payload = {
            ...params,
            TRANGTHAI_UPDATED: "DALAYMAU", // DALAYMAU: khi l·∫•y m·∫´u ;; CHUAKETQUA: khi nh·∫≠n m·∫´u
            note: "",
            type: "KHOALS_LAYMAU"
          };

          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest', // example extra header
              'Authorization': `{{KEY_AUTHOR}} ${localStorage.getItem('access_token')?.replace(/"/g, '') || ''}`
            },
            body: JSON.stringify(payload)
          });

          const data = await response.json();
          return {
            status: response.status,
            data: data
          };
        } catch (error) {
          console.error("Error fetching lab test data:", error);
          throw error;
        }
      },
      postGhiNhanNhanMau: async (params) => {
        try {
          const apiUrl = '/api/pub/xn/ghinhan-trangthai/';

          // üîπ Add extra keys here
          const payload = {
            ...params,
            TRANGTHAI_UPDATED: "CHUAKETQUA", // DALAYMAU: khi l·∫•y m·∫´u ;; CHUAKETQUA: khi nh·∫≠n m·∫´u
            note: "",
            type: "KHOAXN_NHANMAU"
          };

          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest', // example extra header
              'Authorization': `{{KEY_AUTHOR}} ${localStorage.getItem('access_token')?.replace(/"/g, '') || ''}`
            },
            body: JSON.stringify(payload)
          });

          const data = await response.json();
          return {
            status: response.status,
            data: data
          };
        } catch (error) {
          console.error("Error fetching lab test data:", error);
          throw error;
        }
      }
    };

    /**
     * Dynamically creates form inputs based on a provided JSON object and a label map.
     * @param {Object} params A JSON object containing the query parameters and their default values.
     * @param {Object} labels A JSON object mapping parameter keys to human-readable labels.
     */
    function createFormInputs(params, labels) {
      const formContainer = document.getElementById('paramsForm');
      formContainer.innerHTML = ''; // Clear existing inputs

      for (const key in labels) {
        if (labels.hasOwnProperty(key) && params.hasOwnProperty(key)) {
          const div = document.createElement('div');

          const label = document.createElement('label');
          label.htmlFor = key;
          label.className = 'block text-sm font-medium text-gray-700';
          label.textContent = labels[key];

          let input;

          if (key === 'ordering') {
            // üîπ Create a <select> for "ordering"
            input = document.createElement('select');
            input.id = key;
            input.className =
              'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2';

            // Example options (customize as you need)
            const options = listSortXN;

            options.forEach(opt => {
              const option = document.createElement('option');
              option.value = opt.value;
              option.textContent = opt.text;
              if (params[key] === opt.value) {
                option.selected = true;
              }
              input.appendChild(option);
            });
          } else {
            // üîπ Create a normal <input>
            input = document.createElement('input');
            input.id = key;
            input.value = params[key];
            input.className =
              'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2';

            // Determine input type based on the value's format
            if (['page', 'limit'].includes(key)) {
              input.type = 'number';
            } else if (/\d{4}-\d{2}-\d{2}/.test(params[key])) {
              input.type = 'date';
            } else {
              input.type = 'text';
            }
          }

          div.appendChild(label);
          div.appendChild(input);
          formContainer.appendChild(div);
        }
      }
    }

    /**
     * Gathers form values and renders the table.
     */
    async function fetchAndRenderTable() {
      const params = {};
      const formContainer = document.getElementById('paramsForm');
      const userDataString = localStorage.getItem('user');
      const userData = JSON.parse(userDataString);
      // Read values from the dynamically created inputs
      Array.from(formContainer.children).forEach(div => {
        const input = div.querySelector('input, select');
        if (input) {
          params[input.id] = input.value;
        }
      });

      const tableHeader = document.getElementById('tableHeader');
      const tableBody = document.getElementById('tableBody');
      const loadingIndicator = document.getElementById('loading');

      tableBody.innerHTML = '';
      tableHeader.innerHTML = '';
      loadingIndicator.classList.remove('hidden');

      try {
        const responseData = await apiXN.fetchDanhSachXetNghiem(params);
        loadingIndicator.classList.add('hidden');

        const labTests = responseData.data.data;

        // Get the pagination info
        const currentPage = responseData.data.current_page;
        const totalCount = responseData.data.infor_more.count_all;
        const limit = parseInt(params.limit);
        const totalPages = Math.ceil(totalCount / limit);

        // Update pagination UI
        const pageInfo = document.getElementById('pageInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage >= totalPages;

        if (labTests && labTests.length > 0) {
          // Get the column keys from the labels object, ensuring order
          const columnKeys = Object.keys(tableColumnsLabels);

          // Dynamically generate table headers based on the label map.
          columnKeys.forEach(key => {
            // üîπ If it's TRANGTHAI, only show when user is staff
            if (key === 'TRANGTHAI' && !userData.is_staff) {
              return; // skip this column
            }

            const th = document.createElement('th');
            th.scope = 'col';
            th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
            th.textContent = tableColumnsLabels[key];
            tableHeader.appendChild(th);
          });

          // Render the data rows.
          labTests.forEach(test => {
            const row = document.createElement('tr');
            //row.className = 'hover:bg-gray-50 transition-colors duration-200';

            // Set background color based on status
            if (test.LIST_GHINHAN.length > 0) {
              for (const vl of test.LIST_GHINHAN) {
                if (vl.type === "KHOAXN_NHANMAU") {
                  row.className = 'bg-green-50 hover:bg-blue-100 transition-colors duration-200';
                  break;
                }
                if (vl.type === "KHOALS_LAYMAU") {
                  row.className = 'bg-yellow-50 hover:bg-blue-100 transition-colors duration-200';
                  break;
                }
              }
            } else {
              row.className = 'hover:bg-blue-100 transition-colors duration-200';
            }

            columnKeys.forEach(key => {
              // üîπ If it's TRANGTHAI, only show when user is staff
              if (key === 'TRANGTHAI' && !userData.is_staff) {
                return; // skip this column
              }

              const cell = document.createElement('td');

              if (key === 'actions') {
                // Create a container for the action buttons
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex space-x-2';

                // View Details button
                const viewButton = document.createElement('button');
                viewButton.textContent = 'View';
                viewButton.className = 'bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-3 rounded-full text-xs shadow-sm transition-all duration-200';
                viewButton.onclick = () => handleActionClick('view', test);

                // L·∫•y m·∫´u button
                const laymauButton = document.createElement('button');
                laymauButton.textContent = 'L·∫•y m·∫´u (LS)';
                laymauButton.className = 'bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-full text-xs shadow-sm transition-all duration-200';
                laymauButton.onclick = () => handleActionClick('laymau', test);

                // Nh·∫≠n m·∫´u button
                const nhanmauButton = document.createElement('button');
                nhanmauButton.textContent = 'Nh·∫≠n m·∫´u (XN)';
                nhanmauButton.className = 'bg-green-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-full text-xs shadow-sm transition-all duration-200';
                nhanmauButton.onclick = () => handleActionClick('nhanmau', test);

                // Delete button
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-full text-xs shadow-sm transition-all duration-200';
                deleteButton.onclick = () => handleActionClick('delete', test);

                buttonContainer.appendChild(viewButton);
                buttonContainer.appendChild(laymauButton);
                buttonContainer.appendChild(nhanmauButton);
                if (userData.is_staff) {
                  buttonContainer.appendChild(deleteButton);
                }

                cell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900';
                cell.appendChild(buttonContainer);
              } else {
                cell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900';

                let cellContent = test[key];

                // Custom formatting for specific columns
                if (
                  key.includes('NGAYTAO') ||
                  key.includes('NGAYGIOYEUCAU') ||
                  key.includes('NGAYDUKIEN_THUCHIEN') ||
                  key.includes('created_date') ||
                  key.includes('updated_date')
                ) {
                  if (cellContent) {
                    const date = new Date(cellContent);
                    // check valid date
                    if (!isNaN(date.getTime())) {
                      cellContent = date
                        .toLocaleString('en-GB', {
                          day: '2-digit',
                          month: '2-digit',
                          year: 'numeric',
                          hour: '2-digit',
                          minute: '2-digit',
                          second: '2-digit',
                          hour12: false,
                        })
                        .replace(',', '');
                    } else {
                      cellContent = ''; // invalid date string ‚Üí empty
                    }
                  } else {
                    cellContent = ''; // null, undefined, empty ‚Üí empty string
                  }
                } else if (key === 'TRANGTHAI') {
                  cell.classList.remove('text-gray-900');
                  if (cellContent === 'HOANTAT') {
                    cell.classList.add('text-green-600', 'font-semibold');
                  } else {
                    cell.classList.add('text-yellow-600', 'font-semibold');
                  }
                }

                cell.textContent = cellContent;
              }

              row.appendChild(cell);
            });

            tableBody.appendChild(row);
          });
        } else {
          const noDataRow = document.createElement('tr');
          const noDataCell = document.createElement('td');
          noDataCell.colSpan = Object.keys(tableColumnsLabels).length > 0 ? Object.keys(tableColumnsLabels).length : 10;
          noDataCell.className = 'text-center py-8 text-gray-500';
          noDataCell.textContent = 'No lab test data found.';
          noDataRow.appendChild(noDataCell);
          tableBody.appendChild(noDataRow);
        }
      } catch (error) {
        loadingIndicator.classList.add('hidden');
        const errorRow = document.createElement('tr');
        const errorCell = document.createElement('td');
        errorCell.colSpan = Object.keys(tableColumnsLabels).length > 0 ? Object.keys(tableColumnsLabels).length : 10;
        errorCell.className = 'text-center py-8 text-red-500 font-bold';
        errorCell.textContent = `Error: ${error.message}. Please try again later.`;
        errorRow.appendChild(errorCell);
        tableBody.appendChild(errorRow);
      }
    }

    /**
     * Renders the user information from localStorage to a div on the page.
     */
    function renderUserInfor() {
      const userInforDiv = document.getElementById('userInfor');
      const userDataString = localStorage.getItem('user');

      if (!userDataString) {
        userInforDiv.classList.add('hidden');
        return;
      }

      try {
        const userData = JSON.parse(userDataString);
        const userContent = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-800 text-sm">
                    <p><strong>T√™n t√†i kho·∫£n:</strong> ${userData.username || 'N/A'}</p>
                    <p><strong>H·ªç v√† t√™n:</strong> ${userData.first_name || 'N/A'} ${userData.last_name || ''}</p>
                    <p><strong>Email:</strong> ${userData.email || 'N/A'}</p>
                    <p><strong>Vai tr√≤:</strong> ${userData.role_name || 'N/A'}</p>
                    <p><strong>Ph√≤ng ban:</strong> ${userData.department_name || 'N/A'}</p>
                </div>
            `;
        userInforDiv.innerHTML = `<h2 class="text-xl font-bold text-blue-700 mb-4">Th√¥ng tin ng∆∞·ªùi d√πng</h2>${userContent}`;
        userInforDiv.classList.remove('hidden');

      } catch (e) {
        console.error("Failed to parse user data from localStorage:", e);
        userInforDiv.classList.add('hidden');
      }
    }
    /**
     * A helper function to safely get a value from a nested object key string (e.g., 'user_infor.username').
     * @param {Object} obj The object to search within.
     * @param {string} keyString The dot-separated key string.
     * @returns The value, or an empty string if not found.
     */
    function getValueFromNestedKey(obj, keyString) {
      const keys = keyString.split('.');
      let value = obj;
      for (const key of keys) {
        if (value && typeof value === 'object' && value.hasOwnProperty(key)) {
          value = value[key];
        } else {
          return ''; // Return empty string if any part of the path doesn't exist.
        }
      }
      return value || '';
    }

    /**
     * Shows a modal with detailed information for a specific row.
     * @param {Object|Array} data The data object or array for the selected row(s).
     */
    function showModal(data) {
      const modalContainer = document.getElementById('modalContainer');
      const modalContent = document.getElementById('modalContent');
      let objectHeaderShow = tableViewDetailColumnsLabels;
      const dataArray = Array.isArray(data) ? data : [data];

      // Use the comprehensive objectHeaderShow to define what to show.
      // Filter out keys that don't exist in the data.
      const keysToShow = Object.keys(objectHeaderShow)
        .filter(key => key !== 'actions' && dataArray.length > 0);

      let detailHtml = `
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
      `;

      // T·∫°o header (ti√™u ƒë·ªÅ c·ªôt)
      keysToShow.forEach(key => {
        let label = objectHeaderShow[key] || key;
        detailHtml += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${label}</th>`;
      });
      detailHtml += `
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
      `;

      // T·∫°o c√°c h√†ng d·ªØ li·ªáu
      dataArray.forEach(item => {
        detailHtml += `<tr>`;
        keysToShow.forEach(key => {
          // Use the helper function to get the value, which can be nested.
          let value = getValueFromNestedKey(item, key);

          if (
            key.includes('NGAYTAO') ||
            key.includes('NGAYGIOYEUCAU') ||
            key.includes('NGAYDUKIEN_THUCHIEN') ||
            key.includes('created_date') ||
            key.includes('updated_date')
          ) {
            if (value) {
              const date = new Date(value);
              // check valid date
              if (!isNaN(date.getTime())) {
                value = date
                  .toLocaleString('en-GB', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false,
                  })
                  .replace(',', '');
              } else {
                value = ''; // invalid date string ‚Üí empty
              }
            } else {
              value = ''; // null, undefined, empty ‚Üí empty string
            }
          }
          if (value === 'KHOAXN_NHANMAU') {
            value = 'Khoa XN Nh·∫≠n M·∫´u'
          }
          if (value === 'KHOALS_LAYMAU') {
            value = 'Khoa LS L·∫•y M·∫´u'
          }
          detailHtml += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${value}</td>`;
        });
        detailHtml += `</tr>`;
      });

      detailHtml += `
          </tbody>
        </table>
      `;

      modalContent.innerHTML = detailHtml;
      modalContainer.classList.remove('hidden');
      modalContainer.classList.add('flex');
    }

    /**
     * Hides the modal.
     */
    function hideModal() {
      const modalContainer = document.getElementById('modalContainer');
      modalContainer.classList.remove('flex');
      modalContainer.classList.add('hidden');
    }

    /**
     * Handles the click event for the action button in each row.
     * @param {string} action The type of action (e.g., 'view', 'laymau', 'delete').
     * @param {Object} data The data object for the corresponding row.
     */
    /**
    * CHECK L·∫§Y M·∫™U
    */
    async function fetchAndCheckLayMau(data) {
      let check = false;
      const responseData = await apiXN.fetchCheckLayMau(data);
      console.log(responseData);
      if (responseData.data) {
        let listData = responseData.data.data

        if (listData === null) {
          showNotify("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ ki·ªÉm tra!", "info");
          return;
        }

        if (listData.length > 0) {
          let dataCheck = listData[0];
          // CHECK data ƒë∆∞·ª£c ph√©p l·∫•y m·∫´u
          if (dataCheck.EDIT_CHECK === "TRUE") {
            check = true
            showNotify(dataCheck.MESSAGE_CHECK, "info");
            return check;
          } else {
            showNotify(dataCheck.MESSAGE_CHECK, "warning");
          }
        } else {
          showNotify("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ ki·ªÉm tra!!", "info");
        }
      } else {
        showNotify("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ ki·ªÉm tra!", "warning");
      }
      return check;
    }
    /**
     * CHECK NH·∫¨N M·∫™U
     */
    async function fetchAndCheckNhanMau(data) {
      let check = false;
      const responseData = await apiXN.fetchCheckNhanMau(data);
      console.log(responseData);
      if (responseData.data) {
        let listData = responseData.data.data

        if (listData === null) {
          showNotify("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ ki·ªÉm tra!", "info");
          return check;
        }

        if (listData.length > 0) {
          let dataCheck = listData[0];
          // CHECK data ƒë∆∞·ª£c ph√©p nh·∫≠n m·∫´u
          if (dataCheck.EDIT_CHECK === "TRUE") {
            check = true
            showNotify(dataCheck.MESSAGE_CHECK, "info");
            return check;
          } else {
            showNotify(dataCheck.MESSAGE_CHECK, "warning");
          }
        } else {
          showNotify("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ ki·ªÉm tra!!", "info");
        }
      } else {
        showNotify("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ ki·ªÉm tra!", "warning");
      }
      return check;
    }
    /**
     * UPDATE GHI NH·∫¨N L·∫§Y M·∫™U
     */
    async function postGhiNhanLayMau(data) {
      let check = false;

      try {
        const responseData = await apiXN.postGhiNhanLayMau(data);

        switch (responseData.status) {
          case 200:
          case 201:
            check = true;
            showNotify(responseData.data.message, "info");
            break;
          case 417:
            check = false;
            showNotify(responseData.data.message, "error");
            break;
          default:
            check = false;
            showNotify(`Unexpected status: ${status}`, "error");
        }
      } catch (error) {
        console.log(`Error posting GhiNhanLayMau: ${error}`);
        check = false;
      }

      return check;
    }
    /**
     * UPDATE GHI NH·∫¨N NH·∫¨N M·∫™U
     */
    async function postGhiNhanNhanMau(data) {
      let check = false;

      try {
        const responseData = await apiXN.postGhiNhanNhanMau(data);

        switch (responseData.status) {
          case 200:
          case 201:
            check = true;
            showNotify(responseData.data.message, "info");
            break;
          case 417:
            check = false;
            showNotify(responseData.data.message, "error");
            break;
          default:
            check = false;
            showNotify(`Unexpected status: ${status}`, "error");
        }
      } catch (error) {
        console.log(`Error posting GhiNhanLayMau: ${error}`);
        check = false;
      }

      return check;
    }
    // Handle ACTION BUTTONS
    async function handleActionClick(action, data) {
      console.log(`Action: ${action} triggered for TIEPNHAN_ID:`, data.TIEPNHAN_ID);

      switch (action) {
        case 'view':
          console.log('Viewing details for:', data);
          showModal(data.LIST_GHINHAN);
          break;

        case 'laymau':
          // console.log('Laymau data for:', data);

          try {
            const check = await fetchAndCheckLayMau({ DVYEUCAU_ID: data.DVYEUCAU_ID || '0' });

            if (check) {
              let check_ghinhan = await postGhiNhanLayMau(data);
              if (check_ghinhan) {
                fetchAndRenderTable();
              }
            }
          } catch (err) {
            console.error("Error in laymau:", err);
          }
          break;

        case 'nhanmau':
          try {
            const check = await fetchAndCheckNhanMau({ DVYEUCAU_ID: data.DVYEUCAU_ID || '0' });

            if (check) {
              let check_ghinhan = await postGhiNhanNhanMau(data);
              if (check_ghinhan) {
                fetchAndRenderTable();
              }
            }
          } catch (err) {
            console.error("Error in nhanmau:", err);
          }
          break;

        case 'delete':
          console.log('Deleting record for:', data);
          break;

        default:
          console.log('Unknown action:', action);
      }
    }

    /**
     * Changes the current page and triggers a new data fetch.
     * @param {number} direction The direction to move (1 for next, -1 for previous).
     */
    function changePage(direction) {
      const pageInput = document.getElementById('page');
      let currentPage = parseInt(pageInput.value);
      currentPage += direction;
      pageInput.value = currentPage;
      fetchAndRenderTable();
    }

    // Default parameters to build the initial form and fetch data
    // Get today's date in YYYY-MM-DD

    const defaultParams = {{ defaultParams }};
    //console.log(defaultParams)

    // Label map to control which parameters are rendered in the form
    const defaultParamsLabels = {{ defaultParamsLabels }};
    //console.log(defaultParamsLabels)

    // Label map to control which table columns are rendered
    const tableColumnsLabels = {{ tableColumnsLabels }};

    // Label map to control which table columns are rendered
    const tableViewDetailColumnsLabels = {{ tableViewDetailColumnsLabels }};

    // List sort 
    const listSortXN = {{ listSortXN }};

    // Initial page load
    window.onload = () => {
      createFormInputs(defaultParams, defaultParamsLabels);
      fetchAndRenderTable();
      renderUserInfor();
    };

    // Event listeners
    document.getElementById('refreshBtn').addEventListener('click', () => fetchAndRenderTable());
    document.getElementById('fetchDataBtn').addEventListener('click', () => {
      fetchAndRenderTable();
    });
    document.getElementById('paramsForm').addEventListener('keypress', (event) => {
      if (event.key === 'Enter') {
        fetchAndRenderTable();
      }
    });

    document.getElementById('prevBtn').addEventListener('click', () => changePage(-1));
    document.getElementById('nextBtn').addEventListener('click', () => changePage(1));
    document.getElementById('closeModalBtn').addEventListener('click', hideModal);
    document.getElementById('modalOverlay').addEventListener('click', hideModal);
  </script>
</body>

</html>