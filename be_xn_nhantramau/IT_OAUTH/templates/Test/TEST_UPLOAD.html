<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic File Uploader</title>
    <!-- Load Tailwind CSS for a modern, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main container card -->
    <div class="bg-white shadow-xl rounded-2xl p-8 max-w-2xl w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Dynamic File Uploader</h1>
        <p class="text-center text-gray-600 mb-8">Specify the URL, method, and other details for your HTTP request.</p>

        <!-- Form for inputs -->
        <div class="space-y-6">
            <!-- URL Input Field -->
            <div>
                <label for="uploadUrl" class="block text-sm font-medium text-gray-700 mb-1">Upload URL</label>
                <input type="text" id="uploadUrl" placeholder="https://example.com/api/upload" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- HTTP Method Selector -->
            <div>
                <label for="httpMethod" class="block text-sm font-medium text-gray-700 mb-1">HTTP Method</label>
                <select id="httpMethod" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                </select>
            </div>

            <!-- ID Input Field -->
            <div>
                <label for="fileId" class="block text-sm font-medium text-gray-700 mb-1">ID (for the server)</label>
                <input type="number" id="fileId" placeholder="e.g., 123" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- File Input Field -->
            <div>
                <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-1">Select a File</label>
                <input type="file" id="fileInput" name="file" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>

            <!-- Custom Header Section -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="headerName" class="block text-sm font-medium text-gray-700 mb-1">Custom Header Name</label>
                    <input type="text" id="headerName" placeholder="e.g., Authorization" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="headerValue" class="block text-sm font-medium text-gray-700 mb-1">Custom Header Value</label>
                    <input type="text" id="headerValue" placeholder="e.g., Bearer token" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-4">
                <!-- Upload Button -->
                <button id="uploadButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Upload File
                </button>
                <!-- Stop Button -->
                <button id="stopButton" class="w-full bg-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Stop Upload
                </button>
            </div>
        </div>

        <!-- Status and Progress Area -->
        <div id="statusContainer" class="mt-8 hidden">
            <!-- Progress bar -->
            <div class="relative pt-1">
                <div class="flex mb-2 items-center justify-between">
                    <div>
                        <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200">
                            Uploading...
                        </span>
                    </div>
                    <div class="text-right">
                        <span id="progressText" class="text-xs font-semibold inline-block text-blue-600">
                            0%
                        </span>
                    </div>
                </div>
                <div class="flex">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="h-2 rounded-full bg-blue-500 transition-all duration-300 ease-in-out" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Status Message -->
            <div id="statusMessage" class="mt-4 text-center p-3 rounded-lg text-sm font-medium"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get all necessary DOM elements
            const uploadUrlInput = document.getElementById('uploadUrl');
            const httpMethodSelect = document.getElementById('httpMethod');
            const fileIdInput = document.getElementById('fileId');
            const fileInput = document.getElementById('fileInput');
            const headerNameInput = document.getElementById('headerName');
            const headerValueInput = document.getElementById('headerValue');
            const uploadButton = document.getElementById('uploadButton');
            const stopButton = document.getElementById('stopButton');
            const statusContainer = document.getElementById('statusContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const statusMessage = document.getElementById('statusMessage');

            // Declare xhr in a higher scope so both buttons can access it
            let xhr = null;

            // Default URL for testing
            uploadUrlInput.value = 'http://192.168.99.143:8001/api/priv/default/files-manager/update-after-create/';

            // Initially disable the buttons
            uploadButton.disabled = true;
            stopButton.disabled = true;

            // Enable the upload button only if a file is selected and a URL is provided
            const updateButtonState = () => {
                const canUpload = fileInput.files.length > 0 && uploadUrlInput.value.trim() !== '';
                uploadButton.disabled = !canUpload;
            };

            fileInput.addEventListener('change', updateButtonState);
            uploadUrlInput.addEventListener('input', updateButtonState);

            // Handle the click event for the upload button
            uploadButton.addEventListener('click', () => {
                // Get all input values
                const url = uploadUrlInput.value.trim();
                const method = httpMethodSelect.value;
                const file = fileInput.files[0];
                const fileId = fileIdInput.value;
                const headerName = headerNameInput.value.trim();
                const headerValue = headerValueInput.value.trim();

                // Simple validation
                if (!url) {
                    showStatus('Please enter an upload URL.', 'warning');
                    return;
                }
                if (!file) {
                    showStatus('Please select a file first.', 'warning');
                    return;
                }

                // Show the status container and reset progress
                statusContainer.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                uploadButton.disabled = true;
                stopButton.disabled = false; // Enable stop button

                // Create a FormData object to send the file and other data
                const formData = new FormData();
                formData.append('file', file);
                if (fileId) {
                    formData.append('id', fileId);
                }

                // Create a new XMLHttpRequest object
                xhr = new XMLHttpRequest();

                // Listen for the 'progress' event to update the progress bar
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = `${percent}%`;
                        progressText.textContent = `${percent}%`;
                    }
                });

                // Listen for the 'load' event, which fires when the request is complete
                xhr.addEventListener('load', () => {
                    uploadButton.disabled = false;
                    stopButton.disabled = true; // Disable stop button
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (xhr.status >= 200 && xhr.status < 300) {
                            showStatus(`Upload complete! Server response: ${JSON.stringify(response, null, 2)}`, 'success');
                        } else {
                            showStatus(`Upload failed! Server status: ${xhr.status}, message: ${JSON.stringify(response)}`, 'error');
                        }
                    } catch (e) {
                        showStatus(`Upload failed! Could not parse server response.`, 'error');
                    }
                });

                // Listen for network errors
                xhr.addEventListener('error', () => {
                    uploadButton.disabled = false;
                    stopButton.disabled = true; // Disable stop button
                    showStatus('Network error occurred. Check your connection or the URL.', 'error');
                });

                // Listen for the 'abort' event
                xhr.addEventListener('abort', () => {
                    uploadButton.disabled = false;
                    stopButton.disabled = true; // Disable stop button
                    showStatus('Upload was stopped by the user.', 'warning');
                });

                // 1. Open the request with the dynamic method and URL.
                xhr.open(method, url);

                // 2. Add the custom header if both a name and value are provided.
                if (headerName && headerValue) {
                    xhr.setRequestHeader(headerName, headerValue);
                }

                // 3. Send the request with the FormData payload.
                xhr.send(formData);
            });

            // Handle the click event for the stop button
            stopButton.addEventListener('click', () => {
                if (xhr) {
                    // This is the key method to cancel the request
                    xhr.abort();
                }
            });

            /**
             * Helper function to display status messages with dynamic styling.
             * @param {string} message - The message to display.
             * @param {string} type - 'success', 'error', or 'warning' for styling.
             */
            function showStatus(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = 'mt-4 text-center p-3 rounded-lg text-sm font-medium whitespace-pre-wrap';
                if (type === 'success') {
                    statusMessage.classList.add('bg-green-100', 'text-green-700');
                } else if (type === 'error') {
                    statusMessage.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'warning') {
                    statusMessage.classList.add('bg-yellow-100', 'text-yellow-700');
                }
            }
        });
    </script>
</body>
</html>
